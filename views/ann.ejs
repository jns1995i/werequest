<% layout('layout') %>
<head>
    <style>
        .main { padding-inline: 25%; }
        .annCard {
            height: auto;
            min-height: 300px;
            border-radius: 15px;
            flex-direction: column;
            justify-content: start;
            align-items: start;
            gap: 10px;
            padding: 30px !important;
            position: relative;
            margin-bottom: 24px;
            border: 0.5px green solid;
        }
        .annCard .section { justify-content: start; padding: 5px; }
        .annDate { position: absolute; top: 10px; right: 10px; width: auto; height: auto; margin-bottom: 10px; font-size: 0.8vw; }
        .annPhoto { width: 100%; height: auto; }
        .annPhoto img { width: 100%; height: 100%; border-radius: 0.5vw; }
    </style>
</head>

<!-- New Announcement Form -->
<div class="height100 unseen" id="newCard" style="background: rgba(0, 0, 0, 0.293);">
    <form class="annCard" method="POST" action="/newAnn" enctype="multipart/form-data" style="width: 40%;">
        <div class="height0 justifyEnd">
            <a href="javascript:void(0);" class="nav" id="closeBtn"><i class="fas fa-times"></i> Close</a>
        </div>
        <p class="size30 str500">New Annoucement</p>
        <br>
        <input type="text" name="postBy" value="<%= user._id %>" class="hidden">
        <div class="row">
            <input type="text" name="title" placeholder="Title" required>
        </div>
        <div class="row">
            <textarea name="description" placeholder="Description" required></textarea>
        </div>
        <div class="height0 flex justifyCenter width100 hidden">
            <img id="previewImage" src="/images/annphoto1.jpg" alt="Preview" class="width0 h300 borderRadius20">
        </div>
        <div class="row">
            <div class="field">
                <input type="file" name="image" accept="image/*" onchange="previewFile()" required>
            </div>
        </div>
            <div class="field btn" style="justify-content: end; align-items: end;">
                <button class="nav" type="submit">
                    Add Announcement
                </button>
            </div>
    </form>
</div>



<script>
document.getElementById('announcementForm').addEventListener('submit', function() {
    document.getElementById('loadingMessage').style.display = 'block';
});
</script>


<% announcements.forEach(function(announcement) { %>
<div id="editCard<%= announcement._id %>" class="height100 unseen bgSoft">
    <form class="annCard" id="editForm<%= announcement._id %>" method="POST" action="/editAnn/<%= announcement._id %>" enctype="multipart/form-data">
        <input type="hidden" name="id" value="<%= announcement._id %>">
        <div class="height0 justifyEnd">
            <a href="javascript:void(0);" class="nav" onclick="closeEditForm('<%= announcement._id %>')">
                <i class="fas fa-times"></i> Close
            </a>
        </div>
        <div class="row">
            <input type="text" name="title" id="editTitle<%= announcement._id %>" placeholder="Title" value="<%= announcement.title %>" required>
        </div>
        <div class="section mainCN">
            <textarea name="description" id="editDescription<%= announcement._id %>" placeholder="Description" required><%= announcement.description %></textarea>
        </div>
        <div class="section">
            <img id="editPreviewImage<%= announcement._id %>" src="<%= announcement.image || '/images/default.jpg' %>" alt="Preview" class="w150 h150">
        </div>
        <div class="row">
            <div class="field">
                <input type="file" id="imageInput<%= announcement._id %>" name="image" accept="image/*" onchange="previewEditImage('<%= announcement._id %>')">
            </div>
            <div class="field btn" style="width: 35%; justify-content: end; align-items: end;">
                <button class="nav pnav" type="submit">
                    Save Changes
                </button>
            </div>
        </div>
    </form>
</div>
<% }); %>

<script>
    // Show Edit Form and Populate Fields
function editAnnouncement(id) {
    const editCard = document.getElementById("editCard" + id);
    const title = document.querySelector(`#editTitle${id}`).value;
    const description = document.querySelector(`#editDescription${id}`).value;
    const img = document.querySelector(`#editPreviewImage${id}`).src;

    document.getElementById("editCard" + id).classList.remove('unseen');
    document.getElementById("editCard" + id).classList.add('seen');
}

// Close Edit Form
function closeEditForm(id) {
    const editCard = document.getElementById("editCard" + id);
    if (editCard) {
        editCard.classList.remove('seen');
        editCard.classList.add('unseen');
    }
}

// Preview Image for Edit Form
function previewEditImage(id) {
    const fileInput = document.getElementById("imageInput" + id);
    const preview = document.getElementById("editPreviewImage" + id);
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();
        reader.onloadend = function() {
            preview.src = reader.result;
        };
        reader.readAsDataURL(file);
    }
}

</script>

<div class="head paddingInline10">
    <div class="height0 justifyStart">
        <p class="size30 colorPrimary str500">Announcements</p>
    </div>
        <div class="searchBar width35">
            <input type="search" id="univ">
            <i class="fas fa-search"></i>
        </div>
    <div class="height0 justifyEnd">
                <a href="javascript:void(0);" class="nav orgBtn" id="newBtn">
                     Add Announcement
                </a>
    </div>
</div>

<div class="main bgSoft borderRadius15 relative">



    <div id="notFound" class="size20 height0 width100 padding20 borderRadius10 hidden">Sorry, No record Found!</div>
    <br>
    <% if (announcements && announcements.length > 0) { %>
        <% announcements.forEach(ann => { %>
            <div class="card annCard darkShadow" style="padding: 10px;">
                
                <div class="justifyBetween gap10">
                    <p class="size24 str600 width0 textCenter"><%= ann.title %></p>
                    <div class="height0 right gap10 width0">
                        <a href="javascript:void(0)" class="nav cnav green" 
                        onclick="editAnnouncement('<%= ann._id %>')">
                        <i class="fas fa-edit"></i>
                        </a>                             
                        <form action="/deleteAnn/<%= ann._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this?');" class="width0 height0 transparent vers border0 borderRadiusNone">
                            <button type="submit" class="nav cnav border0 green border0">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                        
                    </div>
                </div>
                <div class="height0 gap10 justifyStart">
                    <div class="section padding5 borderRadius5 bgTint9 width0">
                        Posted by: 
                        <% if (ann.residentDetails) { %>
                            <%= ann.residentDetails.firstName %> <%= ann.residentDetails.lastName %>
                        <% } else { %>
                            Unknown Resident
                        <% } %>
                    </div>
                    <div class="section padding5 borderRadius5 bgTint9 width0">
                        Published: <%= ann.createdAt.toDateString() %>
                    </div>
                </div>
                <br>
                <div class="section mainCN">
                    <p class="width100"><%= ann.description %></p>
                </div>
                <div class="section annPhoto">
                    <% if (ann.image) { %>
                        <img src="<%= ann.image %>" alt="Announcement Image" width="100px" height="100px" class="borderPrimary">
                    <% } else { %>
                        <p>No Image Available</p>
                    <% } %>
                </div>
            </div>
        <% }); %>
    <% } else { %>
        <p>No announcements available.</p>
    <% } %>
</div>
<script>
    // Preview Image for both new and edit forms
    function previewFile() {
        const preview = document.getElementById("previewImage");
        const file = document.querySelector('input[name="image"]').files[0];
        const reader = new FileReader();

        reader.onload = function () {
            preview.src = reader.result;
        };

        if (file) {
            reader.readAsDataURL(file);
        }
    }

    // Show new announcement form when "Post News" button is clicked
    document.getElementById("newBtn").addEventListener("click", function(event) {
        event.preventDefault();
        document.getElementById("newCard").classList.remove("unseen");
        document.getElementById("newCard").classList.add("seen");
    });

    // Close the form and hide it when the close button is clicked
    document.getElementById('closeBtn').addEventListener('click', function() {
        document.getElementById("newCard").classList.remove("seen");
        document.getElementById("newCard").classList.add("unseen");
    });
</script>
<script>
    document.getElementById("univ").addEventListener("input", function () {
        let filter = this.value.toLowerCase();
        let annCards = document.querySelectorAll(".annCard");
        let found = false;

        // If the search field is empty, show all cards and hide "NOT FOUND"
        if (filter === "") {
            annCards.forEach(card => card.style.display = "flex");
            document.getElementById("notFound").style.display = "none";
            return;
        }

        // Hide cards that don't match the filter and show matching ones
        annCards.forEach(card => {
            let title = card.querySelector(".title") ? card.querySelector(".title").textContent.toLowerCase() : '';
            let description = card.querySelector(".mainCN p") ? card.querySelector(".mainCN p").textContent.toLowerCase() : '';
            
            // Check if either title or description matches the filter
            if (title.includes(filter) || description.includes(filter)) {
                card.style.display = "flex";
                found = true;
            } else {
                card.style.display = "none";
            }
        });

        // Show "NOT FOUND" if no matches are found
        document.getElementById("notFound").style.display = found ? "none" : "flex";
    });
</script>
